"""
This script takes output file from FlashFry discovere command with -positionOutput argument on
This file has last columns as follow:
CTTCGAGCAAACGGAGCAGCCGG_3_3<03|chr|HA412.bronze.20140814:103115237^F|03|chr|HA412.bronze.20140814:108017433^R|17|chr|HA412.bronze.20140814:192844777^R>,GATAGAATATATGGAGCAGCTGG_1_4<05|chr|HA412.bronze.20140814:122363234^R>,GATCAAATAAACGGAGGATCGGG_2_4<05|chr|HA412.bronze.20140814:59811374^F|00|unplaced_join_73Ns|HA412.bronze.20140814:104287234^R>,GATCGAACAAAAGTAGCAGCGGG_1_4<11|chr|HA412.bronze.20140814:197270201^F>,GATCGAAGAAACGGGGCTGCTGG_2_4<02|chr|HA412.bronze.20140814:187038035^F|04|chr|HA412.bronze.20140814:10138899^R>,GCTCGAACAAAAGTAGCAGCGGG_1_4<01|chr|HA412.bronze.20140814:52861861^F>,GGTCAAATAAACGGAACAACAGG_2_4<03|chr|HA412.bronze.20140814:199676993^F|03|chr|HA412.bronze.20140814:200445982^F>,GGTCGAAAAACCGGAGCACCGGG_2_4<00|unplaced_join_73Ns|HA412.bronze.20140814:104074137^F|00|unplaced_join_73Ns|HA412.bronze.20140814:104475801^R>,GGTGGAATAAATGGATCAGCAGG_1_4<12|chr|HA412.bronze.20140814:4054416^F>,GGTTGAATAAATGGAGCAACTGG_2_4<05|chr|HA412.bronze.20140814:1007609^R|05|chr|HA412.bronze.20140814:1145518^R>,GTACGAATAAGCGGACCAGGAGG_2_4<09|chr|HA412.bronze.20140814:133171203^R|00|unplaced_join_73Ns|HA412.bronze.20140814:344514410^F>,GTTAGAACAAAAGTAGCAGCGGG_1_4<11|chr|HA412.bronze.20140814:174986341^F>,GTTCAAACAAAAGCAGCAGCGGG_1_4<09|chr|HA412.bronze.20140814:207937144^F>,GTTCAAACAAAAGTAGCAGCGGG_2_4<13|chr|HA412.bronze.20140814:236644576^F|04|chr|HA412.bronze.20140814:105093022^F>,GTTCAAATAAGAGCAGCAGCGGG_1_4<00|unplaced_join_73Ns|HA412.bronze.20140814:202132788^R>,GTTCAAATAAGAGTAGCAGCGGG_1_4<12|chr|HA412.bronze.20140814:162808346^R>,GTTCAAATAAGCGGAACTGCTGG_1_4<13|chr|HA412.bronze.20140814:155943020^F>,GTTCAAATGAACAGAGCAGCAGG_1_3<08|chr|HA412.bronze.20140814:129207470^R>,GTTCGAAAAAACGGTGTAACGGG_1_4<05|chr|HA412.bronze.20140814:261514391^F>,GTTCGAAAAATAGTAGCAGCGGG_2_4<11|chr|HA412.bronze.20140814:204852960^R|11|chr|HA412.bronze.20140814:203483314^F>,GTTCGAACAAAAGTAACAGCGGG_1_4<10|chr|HA412.bronze.20140814:130391071^R>,GTTCGAACAAAAGTAGCAACGGG_1_4<15|chr|HA412.bronze.20140814:118559199^R>,GTTCGAACAAAAGTAGCAGCGGG_9_3<02|chr|HA412.bronze.20140814:84196898^F|17|chr|HA412.bronze.20140814:236681284^R|13|chr|HA412.bronze.20140814:175227178^R|17|chr|HA412.bronze.20140814:54747399^R|10|chr|HA412.bronze.20140814:187183726^R|02|chr|HA412.bronze.20140814:151851308^F|11|chr|HA412.bronze.20140814:149691780^R|12|chr|HA412.bronze.20140814:8743187^R|10|chr|HA412.bronze.20140814:113023697^F>,GTTCGAACAAAAGTAGCAGTGGG_3_4<08|chr|HA412.bronze.20140814:114624164^R|09|chr|HA412.bronze.20140814:201776765^F|00|unplaced_join_73Ns|HA412.bronze.20140814:264977777^F>,GTTCGAACAAAATTAGCAGCGGG_1_4<12|chr|HA412.bronze.20140814:27133689^R>,GTTCGAACAACAGCAGCAGCGGG_7_4<15|chr|HA412.bronze.20140814:178794445^F|10|chr|HA412.bronze.20140814:260951115^R|05|chr|HA412.bronze.20140814:92326474^R|14|chr|HA412.bronze.20140814:10505976^F|07|chr|HA412.bronze.20140814:39324483^F|04|chr|HA412.bronze.20140814:201852387^R|10|chr|HA412.bronze.20140814:107650891^F>,GTTCGAACAAGAGCAGCAGCGGG_8_4<13|chr|HA412.bronze.20140814:164498266^F|07|chr|HA412.bronze.20140814:30267429^F|05|chr|HA412.bronze.20140814:194671016^F|14|chr|HA412.bronze.20140814:149026294^F|05|chr|HA412.bronze.20140814:60634946^R|03|chr|HA412.bronze.20140814:71230520^F|04|chr|HA412.bronze.20140814:126532085^R|10|chr|HA412.bronze.20140814:121594109^F>,GTTCGAACAAGAGTAGCAGCAGG_1_4<13|chr|HA412.bronze.20140814:134293555^R>,GTTCGAACAAGAGTAGCAGCGGG_79_4<09|chr|HA412.bronze.20140814:252119295^F|02|chr|HA412.bronze.20140814:203323789^F|14|chr|HA412.bronze.20140814:153573715^F|17|chr|HA412.bronze.20140814:153848377^F|06|chr|HA412.bronze.20140814:76891362^R|04|chr|HA412.bronze.20140814:121801695^R|10|chr|HA412.bronze.20140814:139377853^F|03|chr|HA412.bronze.20140814:109613088^F|10|chr|HA412.bronze.20140814:186384804^R|04|chr|HA412.bronze.20140814:55344843^F|01|chr|HA412.bronze.20140814:62933374^R|12|chr|HA412.bronze.20140814:92144442^F|00|unplaced_join_73Ns|HA412.bronze.20140814:278569542^R|08|chr|HA412.bronze.20140814:91681638^F|10|chr|HA412.bronze.20140814:192311767^R|15|chr|HA412.bronze.20140814:125561953^F|03|chr|HA412.bronze.20140814:133545587^R|02|chr|HA412.bronze.20140814:91981190^F|09|chr|HA412.bronze.20140814:199015193^F|00|unplaced_join_73Ns|HA412.bronze.20140814:180981392^R|10|chr|HA412.bronze.20140814:121892250^R|12|chr|HA412.bronze.20140814:101486099^R|00|unplaced_join_73Ns|HA412.bronze.20140814:54868102^R|13|chr|HA412.bronze.20140814:104264248^R|01|chr|HA412.bronze.20140814:148637953^F|17|chr|HA412.bronze.20140814:123881619^R|04|chr|HA412.bronze.20140814:49478913^R|04|chr|HA412.bronze.20140814:30353254^R|17|chr|HA412.bronze.20140814:168088676^R|13|chr|HA412.bronze.20140814:175181350^F|06|chr|HA412.bronze.20140814:83699325^R|10|chr|HA412.bronze.20140814:249311816^R|02|chr|HA412.bronze.20140814:99630684^F|17|chr|HA412.bronze.20140814:135143627^R|09|chr|HA412.bronze.20140814:115039608^R|00|unplaced_join_73Ns|HA412.bronze.20140814:78020330^F|14|chr|HA412.bronze.20140814:36461076^F|09|chr|HA412.bronze.20140814:115041491^R|04|chr|HA412.bronze.20140814:98122694^R|15|chr|HA412.bronze.20140814:179067830^R|04|chr|HA412.bronze.20140814:12781143^F|01|chr|HA412.bronze.20140814:113172316^R|12|chr|HA412.bronze.20140814:155509765^R|16|chr|HA412.bronze.20140814:120414471^R|10|chr|HA412.bronze.20140814:228799397^F|00|unplaced_join_73Ns|HA412.bronze.20140814:81033463^F|07|chr|HA412.bronze.20140814:35469012^R|15|chr|HA412.bronze.20140814:158215552^F|04|chr|HA412.bronze.20140814:132202285^F|09|chr|HA412.bronze.20140814:95921485^F|10|chr|HA412.bronze.20140814:102720521^R|02|chr|HA412.bronze.20140814:147564213^R|02|chr|HA412.bronze.20140814:96546736^R|04|chr|HA412.bronze.20140814:25117429^F|16|chr|HA412.bronze.20140814:109709305^R|08|chr|HA412.bronze.20140814:142071637^F|10|chr|HA412.bronze.20140814:149220414^R|08|chr|HA412.bronze.20140814:63313542^F|16|chr|HA412.bronze.20140814:70964582^R|08|chr|HA412.bronze.20140814:7242810^F|06|chr|HA412.bronze.20140814:94505577^F|02|chr|HA412.bronze.20140814:153086945^R|13|chr|HA412.bronze.20140814:137071272^F|02|chr|HA412.bronze.20140814:13739047^F|04|chr|HA412.bronze.20140814:71755586^F|05|chr|HA412.bronze.20140814:229112744^F|02|chr|HA412.bronze.20140814:117861939^F|13|chr|HA412.bronze.20140814:194512923^F|10|chr|HA412.bronze.20140814:157496264^R|13|chr|HA412.bronze.20140814:19272089^F|12|chr|HA412.bronze.20140814:27144050^R|00|unplaced_join_73Ns|HA412.bronze.20140814:270896729^R|09|chr|HA412.bronze.20140814:51378124^R|11|chr|HA412.bronze.20140814:25890666^R|16|chr|HA412.bronze.20140814:154450623^F|11|chr|HA412.bronze.20140814:131745851^F|07|chr|HA412.bronze.20140814:55233815^F|07|chr|HA412.bronze.20140814:33643496^R|10|chr|HA412.bronze.20140814:140460348^F>,GTTCGAACAATAGTAGCAGCGGG_3_4<09|chr|HA412.bronze.20140814:17195831^F|15|chr|HA412.bronze.20140814:16472200^F|10|chr|HA412.bronze.20140814:245120346^F>,GTTCGAACACAAGTAGCAGCGGG_1_4<00|unplaced_join_73Ns|HA412.bronze.20140814:329616710^R>,GTTCGAACGAACGGCCCAGCCGG_1_4<08|chr|HA412.bronze.20140814:32066905^F>,GTTCGAATAAAATGCGCAGGCGG_2_4<14|chr|HA412.bronze.20140814:60429463^F|09|chr|HA412.bronze.20140814:45780040^R>,GTTCGAATAAACGGAGCAGCCGG_4_0<07|chr|HA412.bronze.20140814:71540984^R|07|chr|HA412.bronze.20140814:71339783^F|14|chr|HA412.bronze.20140814:174333866^F|14|chr|HA412.bronze.20140814:174384257^F>,GTTCGAATAAGACGAGCAGGAGG_2_4<11|chr|HA412.bronze.20140814:50907764^F|11|chr|HA412.bronze.20140814:50770781^R>,GTTCGAATAAGAGCAGCAGCGGG_2_3<13|chr|HA412.bronze.20140814:35004443^F|09|chr|HA412.bronze.20140814:1611615^R>,GTTCGAATAAGAGTAACAGCGGG_1_4<04|chr|HA412.bronze.20140814:32868079^R>,GTTCGAATAAGAGTAGCAGCGGG_12_3<01|chr|HA412.bronze.20140814:115295502^F|09|chr|HA412.bronze.20140814:77483180^F|04|chr|HA412.bronze.20140814:41414048^R|12|chr|HA412.bronze.20140814:95065377^R|13|chr|HA412.bronze.20140814:2726541^F|03|chr|HA412.bronze.20140814:40569748^F|08|chr|HA412.bronze.20140814:142067595^F|13|chr|HA412.bronze.20140814:189849995^R|03|chr|HA412.bronze.20140814:95658817^F|05|chr|HA412.bronze.20140814:139603369^R|02|chr|HA412.bronze.20140814:169479762^R|02|chr|HA412.bronze.20140814:73920643^F>,GTTCTAAGACCCGGAGCAGCAGG_2_4<00|unplaced_join_73Ns|HA412.bronze.20140814:14417251^R|00|unplaced_join_73Ns|HA412.bronze.20140814:141501092^R>,GTTCTAATAAGAGCAGCAGCGGG_1_4<15|chr|HA412.bronze.20140814:148837800^F>,GTTGGAATAAAGGGAGCGTCGGG_2_4<09|chr|HA412.bronze.20140814:114792908^F|09|chr|HA412.bronze.20140814:115250427^R>,GTTGGAATAAATGGAGTAGAAGG_2_4<01|chr|HA412.bronze.20140814:102960250^F|01|chr|HA412.bronze.20140814:102898357^F>,GTTGGTATAAACGGTGGAGCAGG_4_4<15|chr|HA412.bronze.20140814:51754664^F|03|chr|HA412.bronze.20140814:155819945^F|15|chr|HA412.bronze.20140814:3771138^R|00|unplaced_join_73Ns|HA412.bronze.20140814:344644557^R>,GTTGGTATAAAGGGAGCAGAGGG_1_4<16|chr|HA412.bronze.20140814:124401200^R>,GTTTGAAGAATCGGAGCTGCAGG_1_4<04|chr|HA412.bronze.20140814:89221142^F>,GTTTGAATAAGAGTAGCAGCGGG_1_4<10|chr|HA412.bronze.20140814:83515952^R>,GTTTTAATAAACGGACAAGCCGG_1_4<16|chr|HA412.bronze.20140814:160653895^F>,TTTCGAATAAAAGTAGCAGCGGG_1_3<01|chr|HA412.bronze.20140814:48893490^R>
So gRNA<chromosome name^F(or R)| ....>,
"""
import re
import sys
discover_file = sys.argv[1] #r'C:\Users\ikirov\PycharmProjects\CENH3\discover.output'

with open(discover_file) as inFile, open(discover_file + "offTarget.bed", "w") as outFile:
    for i,lines in enumerate(inFile):
        target = lines.split("\t")[3]
        if i != 0:
            offtargets = lines.split("\t")[-1]

            for off_t in offtargets.split(','):
                off_t = off_t[:-1].split("<")
                seq_ot = off_t[0]
                coords = re.split('\^F|\^R', off_t[1])[:-1] #last symbol is space

                for coor in coords:
                    chromosome, start = coor.split(":")
                    if chromosome[0] == "|":
                        chromosome = chromosome[1:]
                    outFile.write("{0}\t{1}\t{2}\t{3}\n".format(chromosome, int(start)-20, int(start)+20, target))

